<!doctype html>
<html>
  <head>
    <title>Neuronal activity analyzer</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='jquery-2.2.3.min.js') }}"></script>
    <script src="{{ url_for('static', filename='common.js') }}"></script>
    <script src="{{ url_for('static', filename='d3.min.js') }}"></script>
    <script src="{{ url_for('static', filename='mpld3.v0.2.js') }}"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
  </head>
  <body bgcolor="#D0D0D0">
    <h1 id="title">Neuronal activity analyzer</h1>

    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <ul class=flashes>
	    {% for message in messages %}
                <li>{{ message }}</li>
	    {% endfor %}
	    </ul>
	{% endif %}
    {% endwith %}

    <!--------------------------------------------------------------------------
      --
      -- Run creation
      --
      -------------------------------------------------------------------------->

    <div id='file_select'>

      <p>To analyze a file, choose it from the list or upload a new file.</p>

      <table class="centered">
	<colgroup>
	  <col span="1" style="width: 300px;">
	  <col span="1" style="width: 300px;">
	</colgroup>
	<tr>
	  <td>
	    <form action="/upload" method=post enctype=multipart/form-data>
              <input type="file" name="uploaded_file" style="width: 65%">
              <input type="submit" value="Upload" style="width: 30%">
	    </form>
	  </td>
	  <td>
	    <input type="text" id="runname" name="runname" value="default"
		   style="width: 55%; margin-right: 0px;">
	    <input type="submit" value="Create run" onclick="create_run_clicked()"
		   style="width: 40%">
	  </td>
	</tr>
	<tr>
	  <td>
	    <select id="fileselect" name="fileselect" size="10"
		    style="width: 100%;" onclick="videoname_clicked()">
              {% for item in files %}
                <option>{{item}}</option>
              {% endfor %}
	    </select>
	  </td>
	  <td>
	    <select id="runselect" name="runselect" size="10"
		    style="width: 100%" onclick="run_clicked()">
	    </select>
	  </td>
	  <td>
	    <input type="submit" value="Delete run" onclick="delete_run_clicked()">
	  </td>
	</tr>
      </table>
    </div>
    <hr>

    <!--------------------------------------------------------------------------
      --
      -- Segmentation
      --
      -------------------------------------------------------------------------->

    <div id="segmentation" style="display: none;">
      <h2>Segmentation</h2>
      <p style="text-align: center;">
	In this step we find the neurons in the video. We assume they do not
	move and one localisation will work for all of the movie.
      </p>
      <table id="segmentation_table" class='centered' cols="4" rows="2" width="80%">
	<tr>
	  <td class="segmentation_table" colspan="2" width="50%">
            <div class="segmentation_title">Source image</div>
	    <p class="segmentation_desc">Choose what data to use for segmentation. Mean is bad if some neurons are rarely active, but filters noise very well. Variance should yield good results, but might also show noise.</p>
	  </td>
	  <td class="segmentation_table" colspan="2" width="50%">
	    <div class="segmentation_title">Gauss filtering</div>
	    <p class="segmentation_desc">
	      Here we filter noise, so random light pixels do not appear as small neurons. Increase, if axons are recognised as neurons<br>
	      Decrease, if small neurons disappear
	    </p>
	  </td>
	</tr>
	<tr>
	  <td class="segmentation_table">
	    <canvas id="source_image" width="400" height="400">
	  </td>
	  <td class="segmentation_table">
	    Source for segmentation: <br>
	    <input type="radio" name="segmentation_source" value="first_frame" onclick="segmentation_parameters_changed()">First frame<br>
	    <input type="radio" name="segmentation_source" value="mean" onclick="segmentation_parameters_changed()" checked>Mean of frames<br>
	    <input type="radio" name="segmentation_source" value="variance" onclick="segmentation_parameters_changed()">Variance of pixels<br>
	  </td>
	  <td class="segmentation_table">
	    <canvas id="filtered_image" width="400" height="400">
	  </td>
	  <td class="segmentation_table">
	    Sigma radius: <br>
	    <input type="text" id="gauss_radius" name="gauss_radius" value="2.0">
	    <input type="submit" onclick="segmentation_parameters_changed()" value="go">
	  </td>
	</tr>
	<tr>
	  <td class="segmentation_table" colspan="2">
            <div class="segmentation_title">Thresholding</div>
	    <p class="segmentation_desc">
	      The image is divided into background and neurons by defining a threshold. Every pixel brighter than the threshold will belong to foreground and every pixel darker to the background. There are several algorithms to choose an appropriate threshold. Click the buttons to use a value provided by an algorithm or define one manually.
	      </p>
	  </td>
	  <td class="segmentation_table" colspan="2">
            <div class="segmentation_title">Segmentation Result</div>
	    <p class="segmentation_desc">
	      Last we apply an algorithm to seperate neurons, which are overlapping. To just use every continuous region as one neuron, select 'fill'.
	    </p>
	  </td>
	</tr>
	<tr>
	  <td class="segmentation_table">
	    <canvas id="thresholded_image" width="400" height="400">
	  </td>
	  <td class="segmentation_table">
	    Threshold(Percent of dynamic range):
	    <br>
	    <input type="text" id="threshold" name="threshold" value="li">
	    <input type="submit" onclick="segmentation_parameters_changed()" value="go">
	    <br>
	    <input type="submit" onclick="apply_li()" value="Li">
	    <input type="submit" onclick="apply_otsu()" value="Otsu">
	    <input type="submit" onclick="apply_yen()" value="Yen">
	  </td>
	  <td class="segmentation_table">
	    <canvas id="segmented_image" width="400" height="400">
	  </td>
	  <td class="segmentation_table">
	    Algorithm: <br>
	    <input type="radio" name="segmentation_algorithm" value="watershed" onclick="segmentation_parameters_changed()" checked>Watershed<br>
	    <input type="radio" name="segmentation_algorithm" value="randomwalk" onclick="segmentation_parameters_changed()">Random walk<br>
	    <input type="radio" name="segmentation_algorithm" value="kmeans" onclick="segmentation_parameters_changed()">K means<br>
	    <input type="radio" name="segmentation_algorithm" value="fill" onclick="segmentation_parameters_changed()">Fill<br>
	  </td>
	</tr>
      </table>
      <hr>
    </div>

    <!--------------------------------------------------------------------------
      --
      -- ROI Editor
      --
      -------------------------------------------------------------------------->

    <div id="roi_editor" style="display: none">
      <h2>ROI editor</h2>
      <p style="text-align: center;">
	In this step the segmentation can be edited for better results.
      </p>
      <table class="centered" id="editor_table">
	<tr>
	  <td>
	    <div id="editor_view" style="position: relative; width: 800px; height: 800px;"
		 tabindex="1">
	      <canvas id='editor_layer0' width="800" height="800"
		      style="position: absolute; top: 0; left: 0; z-index: 0;"></canvas>
	      <canvas id='editor_layer1' width="800" height="800"
		      style="position: absolute; top: 0; left: 0; z-index: 1;"></canvas>
	    </div>
	  </td>
	  <td>
	      Click on a neuron to choose it.<br>
	      <div class="key_label">d</div>: Delete the chosen neuron.<br>
	      <div class="key_label">m</div>: Hover over a second neuron and press this key to merge the two neurons.<br>
	      <div class="key_label">u</div>: Undo the last operation<br>
	      <input id="editor_save" type="submit" value="Save" onclick="editor_save()"
		     style="display: inline;">
	      <div id="saved_label"></div>
	  </td>
	</tr>
      </table>
      <hr>
    </div>

    <!--------------------------------------------------------------------------
      --
      -- Statistics
      --
      -------------------------------------------------------------------------->

    <div id="statistics-button-container" style="display: none;">
      <div id="statistics-button" class="button" onclick="calculate_statistics_clicked()">
	Calculate statistics
      </div>
      <hr>
    </div>

    <div id="statistics" style="display: none;">
      <h2>Statistics</h2>
      <div style="margin: 0 auto; height=500px; text-align: center">
	<!-- <canvas id="overview" height="400px" width="400px" style="display: inline-block; height: 100%"></canvas> -->
	<div id="summary2" style="display: inline-block; height: 100%"></div>
	<div id="summmary" style="display: inline-block;"></div>
	<div id="rasterplot" style="display: inline-block; height: 100%"></div>
	<div id="plot" style="width:80%; height: 400px; margin: 0 auto"></div>
      </div>

      
      
      <hr>
    </div>

    <div id="infoline"></div>
  </body>
</html>
